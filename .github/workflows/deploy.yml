name: Deploy FreshCart Site

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps --no-audit --no-fund

      - name: Build Next.js
        run: npm run build

      # After build, keep prod deps only in node_modules to reduce upload size
      - name: Prune devDependencies (prod only)
        run: npm prune --omit=dev

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.FRESHCART_DEPLOY_KEY }}

      - name: Add droplet to known_hosts
        run: ssh-keyscan -H 134.122.5.11 >> ~/.ssh/known_hosts

      - name: Deploy to droplet (atomic release)
        env:
          HOST: 134.122.5.11
          USERNAME: kevinlin192003
          APP_NAME: FreshCart
          PORT: 4000
        run: |
          RELEASE_ID=$(date +%Y%m%d%H%M%S)
          echo "Release: $RELEASE_ID"

          # Create release dir on droplet
          ssh $USERNAME@$HOST "mkdir -p /var/www/FreshCart/releases/$RELEASE_ID"

          # Rsync to the NEW release directory (no --delete needed)
          rsync -az \
            --exclude ".git" \
            --exclude ".github" \
            ./ $USERNAME@$HOST:/var/www/FreshCart/releases/$RELEASE_ID

          # Switch symlink + restart
          ssh $USERNAME@$HOST << EOF
            set -e
            APP_NAME="${APP_NAME}"
            PORT="${PORT}"
            RELEASE_ID="${RELEASE_ID}"

            sudo mkdir -p /var/www/FreshCart/releases
            sudo chown -R kevinlin192003:kevinlin192003 /var/www/FreshCart

            echo "ðŸ” Switching current symlink..."
            ln -sfn /var/www/FreshCart/releases/\$RELEASE_ID /var/www/FreshCart/current

            cd /var/www/FreshCart/current

            echo "â™»ï¸ Restarting PM2..."
            if pm2 list | grep -q "\$APP_NAME"; then
              pm2 restart "\$APP_NAME"
            else
              pm2 start npm --name "\$APP_NAME" -- start -- --port="\$PORT"
            fi

            pm2 save

            echo "ðŸ§¹ Cleaning old releases (keep last 3)..."
            cd /var/www/FreshCart/releases
            ls -1dt */ | tail -n +4 | xargs -r rm -rf

            echo "âœ… Deployment complete!"
          EOF
